name: release-apk

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    env:
      RELEASE_KEYSTORE_FILE: app/release-signing.keystore

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Restore signing key (optional)
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > "${RELEASE_KEYSTORE_FILE}"
        shell: bash

      - name: Build signed release APK
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 != '' }}
        env:
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
        run: bash ./gradlew :app:assembleRelease
        shell: bash

      - name: Build Release APK
        if: ${{ secrets.RELEASE_KEYSTORE_BASE64 == '' }}
        run: bash ./gradlew :app:assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: pray-journal-release-apk
          path: app/build/outputs/apk/release/*.apk

      - name: Prepare release notes
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          {
            echo "## 기도/감사 한 줄 기록 앱"
            echo
            echo "### 업데이트: ${GITHUB_REF_NAME}"
            echo
            echo "- 기도/감사 한 줄 기록 등록"
            echo "- 카테고리(기도/감사)별 목록 및 삭제"
            echo "- Room + Flow 기반 로컬 영구 저장"
            echo
            echo "### 변경 사항"
            echo "- 밝고 단순한 Material 3 UI로 구성"
            echo "- 빠른 한 줄 입력 경험 정리"
            echo "- GitHub Actions 릴리스 자동화 (태그 기준)"
            echo
            echo "### 설치"
            echo "1) APK 파일을 다운로드합니다."
            echo "2) Android 기기에서 '알 수 없는 앱' 허용 후 설치합니다."
            echo
            echo "### 스크린샷"
            echo "- [캡처 이미지 1(메인)](./docs/screenshot-home.png)"
            echo "- [캡처 이미지 2(작성)](./docs/screenshot-write.png)"
            echo "- [캡처 이미지 3(카테고리)](./docs/screenshot-category.png)"
          } > release-notes.md

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: "Prayer & Gratitude One-line Journal \${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body_path: release-notes.md
          files: app/build/outputs/apk/release/*.apk
